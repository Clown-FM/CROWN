#!/bin/bash
# crown_replay replays test inputs of target program generated by CROWN.

# If mandatory arguments are not given, print the usage.
# ($# : # of arguments)
if [ $# -lt 1 ]
then
echo -e "Usage : crown_replay <PROGRAM_CMD> [OPTION]..."
echo -e "Options:"
echo -e "    -d <DIR>         Use test inputs in the directory <DIR>."
echo -e "                     (Default : testdir)"
echo -e "    -s <ITER_START>  Start the iteration from the <ITER_START>th test."
echo -e "                     (Default : 1)"
echo -e "    -e <ITER_END>    End the iteration to the <ITER_END>th test."
echo -e "                     (Default : # of test inputs in <DIR>)"
else
	CMD=$1
	ITER_START=1
	# Temporarily set ITER_END to -1.
	ITER_END=-1
	DIR=testdir

	# Parse options.
	# ($@ : whole arguments)
	optarr=("$@")
	idx=1
	while [ $idx -lt $# ] 
	do
	case ${optarr[$idx]} in
		-d) # -d : Set directory
		DIR="${optarr[`expr $idx + 1`]}"
		;;
		-s) # -s : Set the starting point of iteration
		if [ "${optarr[`expr $idx + 1`]}" -le 0 ]
		then
			ITER_START=1
		elif [ "${optarr[`expr $idx + 1`]}" -gt 0 ]
		then
			ITER_START="${optarr[`expr $idx + 1`]}"
		else
			echo crown_replay: error: invalid argument for -s option 1>&2
			exit
		fi
		(( idx= $idx+1 ))
		;;
		-e) # -e : Set the end point of iteration
		if [ "${optarr[`expr $idx + 1`]}" -le 0 ]
		then
			ITER_END=1
		elif [ "${optarr[`expr $idx + 1`]}" -gt 0 ]
		then
			ITER_END="${optarr[`expr $idx + 1`]}"
		else
			echo crown_replay: error: invalid argument for -e option 1>&2
			exit
		fi
		(( idx= $idx+1 ))
		;;
		*)
		;;
	esac
	(( idx= $idx+1 ))
	done

	# Check if directory exists.
	if ! [ -d ${DIR} ]
	then
		echo crown_replay: error: directory ${DIR} does not exist 1>&2
		exit
	fi

	# if ITER_END is not set by -e option, set it here.
	if [ $ITER_END -eq -1 ] 
	then
		ITER_END=`ls ${DIR} | grep "input\." | wc -l`
	fi

	# Execute input.n files in $DIR.
	for n in $(seq ${ITER_START} ${ITER_END})
	do
		# If input.n does not exist, stop executing.
		if [ ! -f ${DIR}/input.$n ]
		then
			echo File ${DIR}/input.$n does not exist 1>&2
			echo "-------------------------"
		else
#echo Iteration $n
			export CROWN_TC_FILE=${DIR}/input.$n
			${CMD}
			echo Iteration $n
			echo "-------------------------"
		fi
	done
	# Reset CROWN_TC_FILE.
	export CROWN_TC_FILE=
fi
